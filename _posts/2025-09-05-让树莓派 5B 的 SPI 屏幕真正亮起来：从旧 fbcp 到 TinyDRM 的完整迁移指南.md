---
layout:     post
title:      è®©æ ‘è“æ´¾ 5B çš„ SPI å±å¹•çœŸæ­£äº®èµ·æ¥ï¼šä»æ—§ fbcp åˆ° TinyDRM çš„å®Œæ•´è¿ç§»æŒ‡å—
date:       2025-09-05
header-img: img/post-bg-desk.jpg
catalog: true
---

> ä½ æ˜¯å¦ä¹Ÿé‡åˆ°ï¼šæ ‘è“æ´¾ 5B æ¥ SPI å±å¹•åªäº®èƒŒå…‰å´ä¸æ˜¾ç¤ºä»»ä½•å†…å®¹ï¼Ÿè¿™å…¶å®æ˜¯å› ä¸º **fbcp** ä¾èµ–çš„æ—§æ˜¾ç¤ºæ ˆåœ¨æ–°ç¡¬ä»¶ä¸Šå·²è¢«ç§»é™¤ã€‚æœ¬æ–‡ç”¨ä¸€é”®å¯å¤åˆ¶çš„æ–¹å¼ï¼Œå¸¦ä½ ä»ã€Œç™½å±ã€åˆ°ã€Œæµç•…æ’­æ”¾ 1080Pã€ã€‚

---

## 1â€ƒå‘ç”Ÿäº†ä»€ä¹ˆï¼šä¸ºä»€ä¹ˆ Pi4 çš„é…ç½®åœ¨ Pi5 ä¸Šå¤±æ•ˆï¼Ÿ

- **æ ¸å¿ƒå˜åŠ¨**ï¼šPi5 å½»åº•ç§»é™¤äº† **legacy display stack**ï¼Œé  `DispmanX` å·¥ä½œçš„ `fbcp`ã€`fbcp-ili9341` æ— æ³•è°ƒç”¨ VideoCoreï¼Œä¼šæŠ¥  
  ```
  * failed to open vchiq instance
  ```
- **æ–°æ¶æ„**ï¼šåªæœ‰é€šè¿‡ **DRM/KMS** æˆ– **TinyDRM** é©±åŠ¨æ³¨å†Œçš„ SPI å±å¹•ï¼Œæ‰èƒ½è¢«ç°ä»£æ¡Œé¢è¯†åˆ«ä¸ºç‹¬ç«‹æ˜¾ç¤ºå™¨ï¼Œæ”¯æŒç¡¬ä»¶åŠ é€Ÿæ—‹è½¬ã€çª—å£æ‹–åŠ¨ã€ç”šè‡³ OpenGLã€‚

---

## 2â€ƒä¸‰æ­¥ä¸º SPI å°å±è£…ä¸Šã€Œå®˜æ–¹é©±åŠ¨ã€

> ä»¥ä¸‹å‘½ä»¤é»˜è®¤ä½ ä½¿ç”¨ **Raspberry Pi OS 64 ä½ Bookwormï¼ˆ2023-12-05 ä»¥åç‰ˆæœ¬ï¼‰**ã€‚

### 2.1 æ–­å¼€ HDMIï¼ˆå¯é€‰ï¼‰
å½“ä½ åªæœ‰ SPI å±å¹•æ—¶ï¼Œå¯ç§»é™¤ HDMIï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é€‰ä¸­ä¸‹ä¸€ä¸ªå¯ç”¨ DRM è®¾å¤‡ã€‚

### 2.2 å†™å…¥å›ºä»¶ä¸è®¾å¤‡æ ‘è¦†ç›–å±‚

ä»¥ 1.3â€³ 240Ã—240ã€ST7789W é©±åŠ¨ä¸ºä¾‹â€”â€”è¯¥é©±åŠ¨åŒçº§å…¼å®¹ Joy-IT SBC-LCD01 ä¸ Waveshare SKU19650ã€‚

```bash
# 1. ä¸‹è½½å›ºä»¶å¹¶å¤åˆ¶
sudo wget https://github.com/raspberrypi/firmware/raw/master/boot/overlays/mipi-dbi-spi.dtbo -O /boot/firmware/overlays/mipi-dbi-spi.dtbo
sudo wget https://forums.raspberrypi.com/download/file.php?id=63123 -O /lib/firmware/wavesku19650.bin

# 2. ç¼–è¾‘ /boot/firmware/config.txt
cat <<'EOF' | sudo tee -a /boot/firmware/config.txt

# ST7789 1.3" SPI display
dtoverlay=mipi-dbi-spi,speed=32000000
dtparam=compatible=wavesku19650\0panel-mipi-dbi-spi
dtparam=write-only,cpha,cpol
dtparam=width=240,height=240,width-mm=23,height-mm=23
# æŒ‰å®é™…å¼•è„šåˆ†é…ï¼Œä»¥ä¸‹ä¸ºå®˜æ–¹å‚è€ƒ
dtparam=reset-gpio=27,dc-gpio=25,backlight-gpio=18
EOF
```

### 2.3 æ¥çº¿ï¼ˆâ†’ 40pin GPIOï¼‰

| åŠŸèƒ½ | å›¾æ ‡å¼•è„š | BCM ç¼–å· |
|---|---|---|
| BL   | 12 | 18 |
| DC   | 22 | 25 |
| RST  | 13 | 27 |
| DIN  | 19 | 10  (MOSI) |
| CLK  | 23 | 11  (SCLK) |
| CS   | 24 | 8   (CE0) |
| GND  | 20 | â€” |
| VCC  | 17 | â€” |

å®Œæˆå `sudo reboot`ï¼Œä¼šçœ‹åˆ°ã€Œæ¡Œé¢æ‰©å±•ã€è‡ªåŠ¨å‡ºç°ï¼›è‹¥ä»ç©ºç™½ï¼Œè¯·æ ¸æŸ¥ **ä¾›ç”µ â‰¥1 A** åŠ **å›ºä»¶æ—¥æœŸ â‰¥2023-12-05**ã€‚

---

## 3â€ƒéªŒè¯ï¼šä½ çš„ SPI å±å¹•å·²å˜æˆ `/dev/dri/card2`

```bash
# æŸ¥çœ‹æ˜¯å¦æ³¨å†ŒæˆåŠŸ
$ dmesg | grep mipi-dbi
# é¢„æœŸå‡ºç° panel-mipi-dbi-spi, 240x240

# åˆ—å‡ºæ˜¾å¡
$ ls /dev/dri/
# card0 = HDMIï¼Œcard1 = VC4ï¼Œcard2 = SPI
```

---

## 4â€ƒæŠŠè§†é¢‘ã€Œä¸¢ã€åˆ° SPI å±å¹•

åœ¨ä»…è¿œç¨‹ ssh çš„åœºæ™¯ï¼Œå¸¸ç”¨ä»¥ä¸‹ä¸¤ç»„å‘½ä»¤åˆ‡æ¢è¾“å‡ºç›®æ ‡ï¼š

```bash
# ç¡®è®¤ card2ï¼ˆSPIï¼‰ä¸Šæœ‰ framebuffer
export DISPLAY=:0
export WAYLAND_DISPLAY=wayland-0

# ä»¥ DRM åç«¯å…¨å±æ’­æ”¾
cvlc --vout=drm --fullscreen /opt/videos/test.mp4 &
# è‹¥æƒ³åº”å¯¹ 90Â° æ—‹è½¬ï¼Œå†è¿½åŠ 
# --transform-type=90
```

æ’­æ”¾æ—¶ä½ ä¼šæƒŠè®¶ï¼š1080P ç‰‡æºä¹Ÿèƒ½ä¿æŒ 25â€“30 fpsï¼Œè™½ç„¶é¢œè‰²é˜¶æ¢¯ç•¥æ˜¾ç²—ç³™ï¼Œä½†è¿œè¶…æ—§ fbcp æ–¹æ¡ˆã€‚

---

## 5â€ƒå¸¸è§é—®é¢˜ä¸è§£ç­”ï¼ˆFAQï¼‰

**Q1ï¼šä¸ºä»€ä¹ˆæˆ‘å·²æŒ‰æ•™ç¨‹è¿æ¥ï¼Œä½† dmesg æ—  mipi-dbi æ—¥å¿—ï¼Ÿ**  
Aï¼šå¤§æ¦‚ç‡åœç•™åœ¨ 32 ä½ç³»ç»Ÿã€‚Pi 5 + TinyDRM ç›®å‰ä»…å®˜æ–¹ç»´æŠ¤ 64 ä½é©±åŠ¨ï¼ŒåŠ¡å¿…é‡è£… 64 ä½é•œåƒã€‚

**Q2ï¼šæˆ‘æƒ³ä¿ç•™ HDMIï¼Œå¹¶è‡ªåŠ¨æ‰©å±•è€Œéå¤åˆ¶æ¡Œé¢ï¼Œå¯ä»¥ä¹ˆï¼Ÿ**  
Aï¼šå¯ä»¥ã€‚SPI ä¸ HDMI æ˜¯ä¸¤å¼ **ç‹¬ç«‹** DRM å¡ã€‚è¿›å…¥ã€Œé¦–é€‰é¡¹ â†’ å±å¹•é…ç½®ã€å³å¯æ‹–æ‹½æ’åˆ—ã€‚å¤åˆ¶æ¨¡å¼éœ€è‡ªå·±å†™ composite-wlrootsï¼Œç›®å‰ç¤¾åŒºå®éªŒé˜¶æ®µã€‚

**Q3ï¼šWayfire ä¼šä¸ä¼šæŠŠ SPI å±ä½œä¸ºä¸»å±å¯¼è‡´æ— æ¡Œé¢ï¼Ÿ**  
Aï¼šè‹¥ HDMI æ–­å¼€ï¼ŒSPI ä¼šæ™‹å‡ä¸ºä¸»å±ï¼›ç³»ç»Ÿä¼šæ­£å¸¸æ˜¾ç¤ºç™»å½•ç•Œé¢ã€‚åç»­æ’å…¥ HDMI éœ€æ‰‹åŠ¨ã€Œå±å¹•é…ç½®ã€åˆ‡å›ã€‚

**Q4ï¼šæ—§é¡¹ç›®å¿…é¡»ç”¨ `/dev/fb0` æ€ä¹ˆåŠï¼Ÿ**  
Aï¼šTinyDRM å·²è‡ªå¸¦ **fbdev emulation**ï¼ŒåŠ è½½åä»ä¸º `/dev/fb0`ï¼Œæ•…å…¼å®¹æœ€è€çš„åº”ç”¨ã€‚

---

## 6â€ƒæ‰©å±•é˜…è¯» & æœªæ¥è§„åˆ’

- å®˜æ–¹æ­£æ•´åˆ dtoverlayï¼Œæœªæ¥ä¼šæä¾› **ä¸€å¼ è¦†ç›–å±‚ + panel å‚æ•°** çš„æ–¹å¼ï¼Œå‡å°‘é‡å¤ç¼–è¯‘ã€‚  
- å·²ç¡®è®¤æ”¯æŒåŠå¾…æµ‹åˆ—è¡¨ï¼ˆç¤¾åŒºè®¡åˆ’ï¼‰ï¼šST7735ã€ILI9341ã€SSD1306ã€GC9A01ã€‚

ğŸ‘‰ [å¿«é€ŸæŒæ¡æœ€æ–° SPI å±å…¼å®¹åˆ—è¡¨ï¼Œä¸€é”®ä¸å†è¸©å‘](https://okxdog.com/)

---

## 7â€ƒå°ç»“ï¼šä»…éœ€è®°ä½çš„ä¸‰å¥è¯

1. **Pi5 æ— æ—§ Stackï¼Œåœæ­¢ fbcp**ã€‚  
2. **TinyDRM = DRM + å›ºä»¶æ–‡ä»¶**ï¼ŒåŠ è½½å³æ­£å¸¸æ¡Œé¢ã€‚  
3. **SPI å±å¹•ä¸ HDMI ç‹¬ç«‹**ï¼Œå¯æ‰©å±•ã€å¯æ—‹è½¬ã€ç¡¬ä»¶åŠ é€Ÿã€‚

ğŸ‘‰ [ç°åœ¨å°±åŠ¨æ‰‹ï¼Œååˆ†é’Ÿè®©æ ‘è“æ´¾ 5B çš„ SPI å±å˜ç”Ÿäº§åŠ›å‰¯å±ï¼](https://okxdog.com/)